{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Laporan</title>
  <link rel="stylesheet" href="{% static 'report/css/element.css' %}">
  <link rel="stylesheet" href="{% static 'report/css/layout.css' %}">
  <link rel="stylesheet" href="{% static 'report/css/Chart.min.css' %}">
</head>

<body>
  <div class="content-wrapper">
    <div class="row">
      <div class="col-lg-6 grid-margin stretch-card">
        <div class="card">
          <div class="p-4 border-bottom bg-light">
            <h4 class="card-title mb-0">Laporan Penjualan Barang</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col text-center" style="border-right: 1px solid lightgray;">
                <h3 class="mb-0 font-weight-medium" id="cost"></h3>
                <h6 class="text-muted">Cost</h6>
              </div>
              <div class="col text-center" style="border-right: 1px solid lightgray;">
                <h3 class="mb-0 font-weight-medium" id="gross"></h3>
                <h6 class="text-muted">Gross Profit</h6>
              </div>
              <div class="col text-center">
                <h3 class="mb-0 font-weight-medium" id="net"></h3>
                <h6 class="text-muted">Net Profit</h6>
              </div>
            </div>
            <div class="chart-container mt-2" style="position: relative; height:auto; width:auto">
                <canvas id="areaChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="{% static 'report/js/Chart.min.js' %}"></script>
  <script>
    function formatRupiah(angka, prefix) {
      var number_string = angka.toString().replace(/[^,\d]/g, '').toString(),
        split = number_string.split(','),
        sisa = split[0].length % 3,
        rupiah = split[0].substr(0, sisa),
        ribuan = split[0].substr(sisa).match(/\d{3}/gi);

      // tambahkan titik jika yang di input sudah menjadi angka ribuan
      if (ribuan) {
        separator = sisa ? '.' : '';
        rupiah += separator + ribuan.join('.');
      }

      rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
      return prefix == undefined ? rupiah : (rupiah ? 'Rp' + rupiah : '');
    }

    var sales = JSON.parse('{{sales|safe}}');

    var cost = 0;
    var gross = 0;
    var net = 0;

    $.each(sales, function (key, sale) {
      cost += sale.cost;
      gross += sale.gross_profit;
      net += sale.net_profit
    });

    $('#cost').text(formatRupiah(cost, 'Rp'))
    $('#gross').text(formatRupiah(gross, 'Rp'))
    $('#net').text(formatRupiah(net, 'Rp'));

    var salesByDay = JSON.parse('{{salesByDay|safe}}');
    var dates = [];
    var netList = [];
    var grossList = [];
    var costs = [];
    $.each(salesByDay, function (key, sale) {
      dates.push(sale.date);
      netList.push(sale.net);
      grossList.push(sale.gross);
      costs.push(sale.cost);
    });

    var ctx = document.getElementById('areaChart').getContext('2d');
    var myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [
          {
            label: 'Net',
            data: netList,
            backgroundColor: 'rgba(255, 99, 132, 1)',
            // borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          },
          {
            label: 'Cost',
            data: costs,
            backgroundColor: 'rgba(255, 206, 86, 1)',
            // borderColor: 'rgba(255, 206, 86, 1)',
            borderWidth: 1
          },
          {
            label: 'Gross',
            data: grossList,
            backgroundColor: 'rgba(54, 162, 235, 1)',
            // borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
        ]
      },
      options: {
        scales: {
          yAxes: [
            {
              ticks: {
                beginAtZero: true
              }
            }]
        },
        legend: {
          position: 'bottom',
        },
      }
    });
  </script>
</body>

</html>